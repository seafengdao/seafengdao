# 趋势跟踪与风险控制系统原型设计全面技术文档

版本：v1.0  
日期：2025-09-07  
适用范围：本地网页原型与可扩展后端（可选）

## 1. 文档目的与范围
- 明确“趋势跟踪（TT）”与“风险控制（RC）”两个模块的目标、架构、数据模型、业务规则和实现方案。
- 为研发、测试和后续移动端/桌面端扩展提供统一技术依据。

## 2. 总体目标与非功能性要求
- 目标：以最小可行产品（MVP）快速验证趋势判定与方向审核的闭环；可追溯、可审计、可扩展。
- 非功能：
  - 可用性：本地单文件可运行；零依赖或少依赖；UI简洁一致。
  - 可靠性：关键数据持久化（localStorage/SQLite）；拒绝原因可追溯。
  - 性能：本地交互≤100ms；数据量<1e5条下操作顺畅。
  - 安全：输入校验、最小权限、日志脱敏；后端开放时考虑CSRF/XSS/RBAC。

## 3. 架构设计
- 前端（Web本地原型）：HTML/CSS/JS 单页主体，导航菜单与页面容器；使用 localStorage 存储TT汇总与RC审计。
- 后端（可选）：Python 简易HTTP/Flask 提供审计日志持久化与查询REST接口；SQLite 作为嵌入式库。
- 数据层：
  - 浏览器端：localStorage（trendTrackingData_v1, riskAuditLog_v1）。
  - 服务端：SQLite（trading_audit.db），文本日志（logs/trading_audit.log）。
- 同步：前端直读localStorage；若启用后端，采用REST拉取/提交，前端与后端定期对账/补偿。

## 4. 核心功能模块
### 4.1 趋势跟踪（TT）
- 信号采集：对上涨/下跌/中性信号进行 +1/-1/0 计数与累计（signal_sum）。
- 趋势判定：signal_sum>0 上涨；<0 下跌；=0 中性。
- 视觉规范：
  - 上涨：红色；下跌：深蓝；中性：灰色（箭头与数值保持一致）。
- 持久化：最新汇总写入 localStorage: trendTrackingData_v1。
- 可视化：趋势概要、累计值、信号统计。

### 4.2 风险控制（RC）
- 方向审核：
  - 当 TT 判断为上涨时，禁止“做空”类请求；
  - 当 TT 判断为下跌时，禁止“做多”类请求；
  - 中性则放行方向限制，继续后续规则。
- 额度与仓位：最大风险暴露（如资金占用/杠杆上限）、单笔限额、日内累计限额。
- 审计与提示：对不通过请求记录拒绝原因、TT快照、时间戳、用户输入等；前端给予明确Toast/对话框提示。
- 持久化：localStorage: riskAuditLog_v1；若启用后端，同步落库与日志。

## 5. 关键业务规则
- 趋势方向：signal_sum>0=上涨；<0=下跌；=0=中性。
- 方向限制：上涨禁止做空；下跌禁止做多；
- 风险限额（建议值，可配置）：
  - 单笔金额/杠杆上限；
  - 日内累计损失阈值（触发后冻结新仓）；
  - 相关资产同向风险集中度阈值。
- 审核优先级：方向限制 > 风险限额 > 其他约束。

## 6. 数据模型
- localStorage
  - trendTrackingData_v1: { signal_sum:number, up:int, down:int, neutral:int, updated_at:ts }
  - riskAuditLog_v1: [ { id, ts, req:{side,amount,symbol}, tt_snapshot:{signal_sum}, decision:allow|reject, reason } ]
- SQLite（trading_audit.db）
  - TradingAudit(id, ts, symbol, side, amount, signal_sum, decision, reason, metadata_json)

## 7. 接口设计（启用后端时）
- POST /api/audit
  - 入参：{ symbol, side:buy|sell|short|cover, amount:number, signal_sum:number }
  - 出参：{ decision:allow|reject, reason, audit_id }
- GET /api/audit/{id}
  - 出参：审计详情
- GET /api/trend/summary
  - 出参：{ signal_sum, up, down, neutral, updated_at }

## 8. 前端技术方案
- 页面与组件：
  - 导航菜单：.nav-menu/.nav-item 与 .nav-break 强制换行；
  - 页面容器：.page-container 支持淡入动画与显隐切换；
  - 交互：信号按钮、统计展示、风险审核提示。
- 状态管理：内存状态 + localStorage；关键写入节流/去抖；异常回退。
- 错误处理：输入校验、空数据容错、持久化写入失败回滚。

## 9. 后端技术方案（可选）
- Python + Flask 或轻量HTTP服务；SQLite直连；
- DAO/Repository 简化数据访问；
- 日志：结构化JSON行日志便于检索；异常自动告警（本地以弹窗/日志代替）。

## 10. 风险评估与控制策略
- 市场风险：黑天鹅、流动性骤降 → 预设硬阈值与紧急开关；
- 模型风险：规则失效/过拟合 → A/B 对照、回测、人工兜底；
- 操作风险：误操作/重复提交 → 二次确认、幂等键、节流；
- 技术风险：断电/数据丢失 → 定期快照、落库与日志双写；
- 合规与安全：最小权限、输入校验、日志脱敏、访问控制。

## 11. 日志与审计
- 记录每次拒绝与重要通过决策：时间、请求、TT快照、原因；
- 支持按时间/标的/原因查询；
- 与SQLite落库对齐，保证可追溯链路。

## 12. 安全与权限
- 前端：输入校验、输出转义；
- 后端：鉴权（本地token）、速率限制；
- 数据：敏感字段脱敏与最小化存储。

## 13. 测试与验收
- 单元：趋势计算、方向审核、阈值判断；
- 集成：前后端接口、localStorage与落库一致性；
- E2E：关键用户路径（录入→判定→反馈→审计）；
- 验收标准：方向限制正确率≥99.5%，日志完整率=100%。

## 14. 部署与配置
- 本地：启动静态HTTP服务，直接访问HTML页面；
- 可选后端：配置数据库路径、日志路径、端口；
- 配置文件：config/config.json（阈值、限额、告警开关）。

## 15. 里程碑
- M1 原型闭环：TT信号→RC方向审核→拒绝记录（已完成/验收进行中）。
- M2 风险阈值与仓位管理、UI可配置化、日志检索。
- M3 后端REST与移动端打通、自动化回测与看板。

## 16. 附录：颜色与可用性规范
- 颜色：上涨红、下跌深蓝、中性灰；按钮文字统一白色，悬停仅调亮度；
- 可用性：键盘可达、ARIA标签、错误消息清晰可读。